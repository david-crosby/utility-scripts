#!/bin/zsh
# ------------------------------------------------------------------------------
# Safari Pop-Up Permission Manager
# Adds specified domains to Safari's allowed pop-up sites list
# Compatible with Jamf Pro or standalone execution
# ------------------------------------------------------------------------------
# Author: David Crosby
# LinkedIn: https://www.linkedin.com/in/david-bing-crosby/
# GitHub: https://github.com/david-crosby
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Configuration
# ------------------------------------------------------------------------------

SCRIPT_NAME="${0:t}"
SCRIPT_VERSION="1.0.0"
LOG_FILE="/var/log/safari-popup-manager.log"

# Domains to allow pop-ups from (add more as needed)
ALLOWED_DOMAINS=(
    "insert-here.com"
)

# Pop-up policy values
POPUP_ALLOW=1
POPUP_BLOCK=0
POPUP_BLOCK_NOTIFY=2

# ------------------------------------------------------------------------------
# Logging Functions
# ------------------------------------------------------------------------------

init_logging() {
    # Determine appropriate log location based on permissions
    if [[ ! -w "/var/log" ]]; then
        # Running as standard user, use user-accessible location
        LOG_FILE="${HOME}/Library/Logs/safari-popup-manager.log"
    fi
    
    # Ensure log directory exists
    local log_dir="${LOG_FILE:h}"
    if [[ ! -d "${log_dir}" ]]; then
        mkdir -p "${log_dir}" 2>/dev/null
    fi
    
    # Test write access
    if ! touch "${LOG_FILE}" 2>/dev/null; then
        # Fall back to temp if all else fails
        LOG_FILE="/tmp/safari-popup-manager.log"
    fi
}

log_message() {
    local level="${1}"
    local message="${2}"
    local timestamp
    timestamp="$(date '+%Y-%m-%d %H:%M:%S')"
    
    # Use printf for reliable output
    printf '[%s] [%s] %s\n' "${timestamp}" "${level}" "${message}" | tee -a "${LOG_FILE}" 2>/dev/null
}

log_info() {
    log_message "INFO" "${1}"
}

log_warn() {
    log_message "WARN" "${1}"
}

log_error() {
    log_message "ERROR" "${1}"
}

log_success() {
    log_message "SUCCESS" "${1}"
}

log_separator() {
    log_message "INFO" "----------------------------------------"
}

# ------------------------------------------------------------------------------
# Helper Functions
# ------------------------------------------------------------------------------

get_current_user() {
    # Get the currently logged-in user (excluding system accounts)
    local current_user
    current_user="$(/usr/bin/stat -f '%Su' /dev/console 2>/dev/null)"
    
    if [[ -z "${current_user}" || "${current_user}" == "root" || "${current_user}" == "loginwindow" ]]; then
        return 1
    fi
    
    printf '%s' "${current_user}"
}

get_user_home() {
    local username="${1}"
    local home_dir
    home_dir="$(/usr/bin/dscl . -read "/Users/${username}" NFSHomeDirectory 2>/dev/null | awk '{print $2}')"
    
    if [[ -z "${home_dir}" || ! -d "${home_dir}" ]]; then
        return 1
    fi
    
    printf '%s' "${home_dir}"
}

get_user_uid() {
    local username="${1}"
    /usr/bin/id -u "${username}" 2>/dev/null
}

is_safari_running() {
    /usr/bin/pgrep -x "Safari" >/dev/null 2>&1
}

# ------------------------------------------------------------------------------
# Safari Preference Functions
# ------------------------------------------------------------------------------

backup_safari_prefs() {
    local db_path="${1}"
    local backup_path="${db_path}.backup.$(date +%Y%m%d%H%M%S)"
    
    if [[ -f "${db_path}" ]]; then
        if /bin/cp "${db_path}" "${backup_path}" 2>/dev/null; then
            log_info "Created backup at ${backup_path}"
            return 0
        else
            log_warn "Failed to create backup"
            return 1
        fi
    fi
    
    return 1
}

convert_wildcard_to_safari_format() {
    # Safari stores wildcard domains without the asterisk prefix
    local domain="${1}"
    
    if [[ "${domain}" == \*\.* ]]; then
        printf '%s' "${domain#\*.}"
    else
        printf '%s' "${domain}"
    fi
}

add_popup_permission_to_db() {
    local db_path="${1}"
    local domain="${2}"
    local username="${3}"
    
    local preference_key="PerSitePreferencePopUpPolicy"
    
    if [[ ! -f "${db_path}" ]]; then
        log_warn "Safari preferences database not found at ${db_path}"
        return 1
    fi
    
    local safari_domain
    safari_domain="$(convert_wildcard_to_safari_format "${domain}")"
    
    # Check if entry already exists
    local existing
    existing="$(/usr/bin/sqlite3 "${db_path}" \
        "SELECT preference_value FROM default_preferences WHERE domain = '${safari_domain}' AND preference_key = '${preference_key}';" 2>/dev/null)" || existing=""
    
    if [[ "${existing}" == "${POPUP_ALLOW}" ]]; then
        log_info "Pop-up permission already set for ${domain}"
        return 0
    fi
    
    # Insert or update the preference
    if /usr/bin/sqlite3 "${db_path}" \
        "INSERT OR REPLACE INTO default_preferences (domain, preference_key, preference_value) VALUES ('${safari_domain}', '${preference_key}', ${POPUP_ALLOW});" 2>/dev/null; then
        log_success "Added pop-up permission for ${domain}"
        /usr/sbin/chown "${username}" "${db_path}" 2>/dev/null
        return 0
    else
        log_error "Failed to add pop-up permission for ${domain}"
        return 1
    fi
}

add_popup_via_defaults() {
    # Alternative method using defaults command for managed preferences
    local domain="${1}"
    local username="${2}"
    local uid="${3}"
    
    local safari_domain
    safari_domain="$(convert_wildcard_to_safari_format "${domain}")"
    
    log_info "Attempting to set preference via defaults for ${domain}"
    
    # Use launchctl to run as the user context
    if /bin/launchctl asuser "${uid}" /usr/bin/sudo -u "${username}" \
        /usr/bin/defaults write com.apple.Safari \
        "com.apple.Safari.ContentPageGroupIdentifier.WebKit2JavaScriptCanOpenWindowsAutomatically.${safari_domain}" \
        -bool true 2>/dev/null; then
        log_success "Set preference via defaults for ${domain}"
        return 0
    else
        log_error "Failed to set preference via defaults for ${domain}"
        return 1
    fi
}

# ------------------------------------------------------------------------------
# Main Functions
# ------------------------------------------------------------------------------

check_prerequisites() {
    log_info "Checking prerequisites"
    
    if [[ "$(uname)" != "Darwin" ]]; then
        log_error "This script only runs on macOS"
        return 1
    fi
    
    if ! command -v sqlite3 >/dev/null 2>&1; then
        log_error "sqlite3 command not found"
        return 1
    fi
    
    if [[ ${EUID} -ne 0 ]]; then
        log_warn "Script not running as root - some operations may fail"
    fi
    
    log_info "Prerequisites check passed"
    return 0
}

process_user() {
    local username="${1}"
    local user_home="${2}"
    local user_uid="${3}"
    local success_count=0
    local fail_count=0
    
    log_info "Processing user: ${username}"
    
    local safari_prefs_dir="${user_home}/Library/Safari"
    local prefs_db="${safari_prefs_dir}/PerSitePreferences.db"
    
    if [[ ! -d "${safari_prefs_dir}" ]]; then
        log_warn "Safari preferences directory not found for ${username}"
        log_info "User may not have launched Safari yet - will use defaults method"
    fi
    
    if [[ -f "${prefs_db}" ]]; then
        backup_safari_prefs "${prefs_db}"
    fi
    
    local domain
    for domain in "${ALLOWED_DOMAINS[@]}"; do
        log_info "Processing domain: ${domain}"
        
        if [[ -f "${prefs_db}" ]]; then
            if add_popup_permission_to_db "${prefs_db}" "${domain}" "${username}"; then
                (( success_count++ ))
            else
                if add_popup_via_defaults "${domain}" "${username}" "${user_uid}"; then
                    (( success_count++ ))
                else
                    (( fail_count++ ))
                fi
            fi
        else
            if add_popup_via_defaults "${domain}" "${username}" "${user_uid}"; then
                (( success_count++ ))
            else
                (( fail_count++ ))
            fi
        fi
    done
    
    log_info "Completed processing for ${username}: ${success_count} succeeded, ${fail_count} failed"
    
    [[ ${fail_count} -eq 0 ]]
}

main() {
    # Initialise logging first
    init_logging
    
    log_separator
    log_info "Starting ${SCRIPT_NAME} v${SCRIPT_VERSION}"
    log_info "Log file: ${LOG_FILE}"
    log_separator
    
    if ! check_prerequisites; then
        log_error "Prerequisites check failed"
        exit 1
    fi
    
    local current_user
    current_user="$(get_current_user)"
    
    if [[ -z "${current_user}" ]]; then
        log_error "No user currently logged in"
        exit 1
    fi
    
    log_info "Current user: ${current_user}"
    
    local user_home
    user_home="$(get_user_home "${current_user}")"
    
    if [[ -z "${user_home}" ]]; then
        log_error "Could not determine home directory for ${current_user}"
        exit 1
    fi
    
    local user_uid
    user_uid="$(get_user_uid "${current_user}")"
    
    if [[ -z "${user_uid}" ]]; then
        log_error "Could not determine UID for ${current_user}"
        exit 1
    fi
    
    log_info "User home: ${user_home}"
    log_info "User UID: ${user_uid}"
    
    if is_safari_running; then
        log_warn "Safari is currently running"
        log_info "Changes will take effect after Safari restart"
    fi
    
    if process_user "${current_user}" "${user_home}" "${user_uid}"; then
        log_success "Script completed successfully"
        exit 0
    else
        log_error "Script completed with errors"
        exit 1
    fi
}

# ------------------------------------------------------------------------------
# Entry Point
# ------------------------------------------------------------------------------

main "$@"
